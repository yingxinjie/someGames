{"version":3,"sources":["assets\\script\\bundleLoader.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["window[\"REMOTE_SERVER_ROOT\"] = cc.assetManager.downloader.remoteServerAddress;\r\nwindow[\"REMOTE_BUNDLE_MANIFEST\"] = REMOTE_SERVER_ROOT + 'remote/manifest.json';\r\n\r\nexport namespace bundleLoader {\r\n    export type TYPE_MANIFEST = { [key: string]: string }\r\n    export enum ENUM_BUNDLE {\r\n        BASE = '00_base',\r\n        HALL = '01_hall',\r\n        GAME = '02_game',\r\n    }\r\n\r\n    export const ENUM_BUNDLE_SAVE: { [key: string]: cc.AssetManager.Bundle } = {}\r\n\r\n}\r\n\r\n//注册持久存储\r\nfunction regLocalStorage(storageKey: string) {\r\n    return (target, propertyKey: string) => {\r\n        Object.defineProperty(target, propertyKey, {\r\n            get: function (): number {\r\n                return cc.sys.localStorage.getItem(storageKey);\r\n            },\r\n            set: function (val: string) {\r\n                if (val == null)\r\n                    cc.sys.localStorage.removeItem(storageKey);\r\n                else\r\n                    cc.sys.localStorage.setItem(storageKey, val);\r\n            },\r\n        });\r\n    }\r\n}\r\n\r\nexport namespace bundleLoader {\r\n\r\n    class _model {\r\n        @regLocalStorage(\"BUNDLE_MANIFEST\")\r\n        storeManifest: string;\r\n\r\n        get manifest(): TYPE_MANIFEST {\r\n            if (this.storeManifest == null) return null;\r\n            return JSON.parse(this.storeManifest);\r\n        }\r\n        set manifest(value: TYPE_MANIFEST) {\r\n            if (value == null) this.storeManifest = null;\r\n            else this.storeManifest = JSON.stringify(value);\r\n        }\r\n\r\n        //检查版本\r\n        async checkBundleVersion() {\r\n            if (CC_PREVIEW || !CC_JSB) return;\r\n            cc.log(`Bundle版本检查开始`);\r\n            let manifest = await this.getRemoteBundleVersion();\r\n            if (manifest == null) return false;\r\n            for (let bundleName in this.manifest) {\r\n                if (this.manifest[bundleName] != manifest[bundleName]) {\r\n                    if (cc.assetManager.getBundle(bundleName) != null) {\r\n                        cc.log(`bundle 存在更新 名：${bundleName} 当前版本:${this.manifest[bundleName]} 远程版本:${manifest[bundleName]}`);\r\n                        return true;\r\n                    }\r\n                }\r\n            }\r\n            cc.log(`Bundle版本检查完成`);\r\n            return false;\r\n        }\r\n\r\n        //获取版本\r\n        async getRemoteBundleVersion() {\r\n            if (CC_PREVIEW || !CC_JSB) return;\r\n            let manifest = await new Promise<TYPE_MANIFEST>((resolve, reject) => {\r\n                cc.assetManager.downloader['downloadFile'](REMOTE_BUNDLE_MANIFEST, { responseType: 'json' }, null, (err, manifest: TYPE_MANIFEST) => {\r\n                    if (err) {\r\n                        cc.error('获取远程版本错误' + JSON.stringify(err));\r\n                        resolve(null);\r\n                        return;\r\n                    }\r\n                    resolve(manifest)\r\n                });\r\n            });\r\n            return manifest;\r\n        }\r\n\r\n        async loadBundle(enumBundle: ENUM_BUNDLE) {\r\n            return new Promise<cc.AssetManager.Bundle>((resolve, reject) => {\r\n                let cb = (err, bundle: cc.AssetManager.Bundle) => {\r\n                    if (err) {\r\n                        cc.error('加载Bundle错误' + JSON.stringify(err));\r\n                        reject(err);\r\n                        return;\r\n                    }\r\n\r\n                    ENUM_BUNDLE_SAVE[enumBundle] = bundle;\r\n                    console.log(`bundle包${enumBundle}加载完成`)\r\n                    resolve(bundle);\r\n                };\r\n\r\n                if (CC_JSB && !CC_PREVIEW) {\r\n                    if (this.manifest[enumBundle] == null) throw '远程版本不存在';\r\n                    cc.assetManager.loadBundle(REMOTE_SERVER_ROOT + 'remote/' + enumBundle, { version: this.manifest[enumBundle] }, cb);\r\n                }\r\n                else {\r\n                    cc.assetManager.loadBundle(enumBundle, cb);\r\n                }\r\n            });\r\n        }\r\n\r\n\r\n        async Bundle(enumBundle: ENUM_BUNDLE) {\r\n\r\n\r\n        }\r\n    }\r\n\r\n    export const model = new _model();\r\n\r\n}"]}